#!/usr/bin/env python3
"""
Ğ˜Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ CLI Ğ´Ğ»Ñ GigaAM v3 Transcriber
ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Linux Ğ¸ macOS
"""

import os
import sys
import warnings
from pathlib import Path

# ĞŸĞ¾Ğ´Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ
warnings.filterwarnings("ignore", category=UserWarning, module="pyannote")
warnings.filterwarnings("ignore", category=UserWarning, module="speechbrain")
warnings.filterwarnings("ignore", category=UserWarning, module="torchaudio")

# ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ°Ñ‚Ñ‡ Ğ´Ğ»Ñ pyannote.audio Ğ¿ĞµÑ€ĞµĞ´ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼
from src.utils.pyannote_patch import apply_pyannote_patch
apply_pyannote_patch()

from rich.console import Console
from rich.panel import Panel
from rich.text import Text
from rich.table import Table
from rich import box
from rich.prompt import Prompt, Confirm
from rich.progress import (
    Progress,
    SpinnerColumn,
    TextColumn,
    BarColumn,
    TaskProgressColumn,
    TimeRemainingColumn,
    TimeElapsedColumn
)

from src.cli import CLIInterface


def print_banner(console: Console):
    """Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ĞºÑ€Ğ°ÑĞ¸Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ½Ğ½ĞµÑ€ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"""
    banner = Text()
    banner.append("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n", style="bold cyan")
    banner.append("â•‘  ", style="bold cyan")
    banner.append("ğŸ™ï¸  GigaAM v3 Transcriber - CLI Edition", style="bold yellow")
    banner.append("  ğŸ™ï¸  â•‘\n", style="bold cyan")
    banner.append("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n", style="bold cyan")
    banner.append("â•‘  ", style="bold cyan")
    banner.append("Ğ¢Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ Ğ°ÑƒĞ´Ğ¸Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾ â†’ Ğ¢ĞµĞºÑÑ‚", style="bold white")
    banner.append("                  â•‘\n", style="bold cyan")
    banner.append("â•‘  ", style="bold cyan")
    banner.append("Powered by Sber GigaAM-v3", style="italic bright_black")
    banner.append("                            â•‘\n", style="bold cyan")
    banner.append("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•", style="bold cyan")
    
    console.print(banner)
    console.print()


def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ CLI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"""
    console = Console()
    
    try:
        # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑĞºÑ€Ğ°Ğ½Ğ°
        console.clear()
        
        # Ğ‘Ğ°Ğ½Ğ½ĞµÑ€
        print_banner(console)
        
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ CLI Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
        cli = CLIInterface(console)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        if not cli.check_configuration():
            console.print("\n[bold red]âœ— ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸![/bold red]")
            console.print("\n[yellow]Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞµ:[/yellow]")
            console.print("1. Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° https://huggingface.co")
            console.print("2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½: https://huggingface.co/settings/tokens")
            console.print("3. ĞŸÑ€Ğ¸Ğ¼Ğ¸Ñ‚Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ: https://huggingface.co/pyannote/segmentation-3.0")
            console.print("4. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» .env Ğ² ĞºĞ¾Ñ€Ğ½Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°")
            console.print("5. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ: HF_TOKEN=Ğ²Ğ°Ñˆ_Ñ‚Ğ¾ĞºĞµĞ½_Ğ·Ğ´ĞµÑÑŒ\n")
            
            if not Confirm.ask("[yellow]ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ±ĞµĞ· Ñ‚Ğ¾ĞºĞµĞ½Ğ°?[/yellow] (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ°)"):
                return
        
        # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
        cli.run()
        
    except KeyboardInterrupt:
        console.print("\n\n[yellow]âš ï¸  Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼[/yellow]")
        sys.exit(0)
    except Exception as e:
        console.print(f"\n[bold red]âœ— ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {str(e)}[/bold red]")
        import traceback
        console.print(f"[dim]{traceback.format_exc()}[/dim]")
        sys.exit(1)


if __name__ == "__main__":
    main()

